# ArgoCD를 이용한 배포

## ArgoCD 설치

```bash
kubectl create namespace argocd
# namespace/argocd created

kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
# customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created
# customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created
# serviceaccount/argocd-application-controller created
# serviceaccount/argocd-dex-server created
# ...
```

ArgoCD 경우, tls 설정을 강제합니다. HTTP 프로토콜로 접속 시 강제로 HTTPS로 리다이렉트

```yaml
# argocd-ingress.yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: argocd
  namespace: argocd
  annotations:
    cert-manager.io/cluster-issuer: http-issuer
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/backend-protocol: HTTPS
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  rules:
  - host: argocd.10.0.1.1.sslip.io
    http:
      paths:
      - path: /
        backend:
          serviceName: argocd-server
          servicePort: https
  tls:
  - hosts:
    - argocd.10.0.1.1.sslip.io
    secretName: argocd-tls
```

---

**참고** 

1. tls 설정을 하지 않는 경우 `--insecure` 옵션을 지정하여 피해갈 수도 있습니다. ([https://argoproj.github.io/argo-cd/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts](https://argoproj.github.io/argo-cd/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts))

	---

```bash
kubectl apply -f argocd-ingress.yaml
# ingress.networking.k8s.io/argocd created
```

- 아이디: admin
- 비밀번호: 다음 명령를 이용하여 비밀번호를 확인합니다.

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server \
    -o name | cut -d'/' -f 2
# argocd-server-6766455855-pzdrv    --> 비밀번호
```

ArgoCD를 설치하여 로그인하면 가장 먼저 볼 수 있는 화면은 다음과 같습니다. 지금까지 배포된 App의 리스트를 보여주는 화면입니다. 현재는 배포된 App이 없기 때문에 비어있습니다. 새로운 배포를 관장하는 App을 생성해 보기 위해 `New App` 버튼을 누릅니다.

![[그림 15-9] ArgoCD Web UI](15-09.png)

<!-- 단일 진실의 원천을 설정하는 화면 (Git 설정화면) 입니다. -->

다음과 같이 단일 진실의 원천을 설정해 봅시다.

<!-- ![[그림 15-10] Git 설정화면](15-10.png) -->

- `Application Name`: Application의 이름을 지정합니다.
- `Project`: 프로젝트를 선택하는 필드입니다. 쿠버네티스의 네임스페이스와 비슷한 개념으로 여러 App을 논리적인 project로 구분하여 관리할 수 있습니다.
- `Sync Policy`: Git 저장소의 변경 사항을 어떻게 sync할지 결정합니다. Auto는 자동으로 Git 저장소의 변경사항을 운영에 반영하고 Manual은 사용자가 버튼 클릭을 통해  운영 반영을 해줘야 합니다.
- `Repository URL`: ArgoCD가 바라볼 단일 진실의 원천 Git 저장소를 지정합니다.
- `Revision`: Git의 어떤 revision(HEAD, master branch 등)을 바라 볼지 결정합니다.
- `Path`: Git 저장소에서 어떤 디렉토리를 바라볼지 결정합니다. dot(.)인 경우 root path를, 디렉토리 이름을 적으면 해당 디렉토리의 YAML 정의서만 배포합니다.
- `Cluster`: 쿠버네티스 클러스터 지정합니다. 복수의 클러스터를 운영할 때 유용합니다.
- `Namespace`: 클러스터 내 네임스페이스를 지정합니다.
- `Directory Recurse`: Path 아래의 디렉토리를 재귀적으로 트래킹할지를 결정합니다(디렉토리 아래 또 디렉토리가 있는 경우).

## ArgoCD 배포

마찬가지로 앞에서 배포한 `gitops-get-started` 레포지토리를 ArgoCD에서도 원천으로 사용해 봅시다.

- `Application Name`: gitops-get-started
- `Project`: default
- `Sync Policy`: Manual
- `Repository URL`: `https://github.com/hongkunyoo/gitops-get-started.git`
- `Revision`: HEAD
- `Path`: .
- `Cluster`: in-cluster
- `Namespace`: default
- `Directory Recurse`: Unchecked

`CREATE` 버튼을 누른 이후 App이 생성됩니다. App의 `SYNC` 버튼을 누르면 다음과 같이 nginx `Service`와 `Pod`가 생성된 것을 UI로 확인하실 수 있습니다.

![[그림 15-11] Application 연결](15-11.png)

`App Details` 버튼을 누르거나 각 리소스UI를 클릭하시면 더 자세한 내용들을 직접 볼 수 있습니다.

![[그림 15-12] App 상세 화면](15-12.png)

앞서 App을 설정할 때 `sync-policy`를 `Manual`로 설정하였습니다. 아래에 `Auto-Sync` 버튼을 활성화하게 되면 `Automatic`이 되어 매번 사람이 직접 변경사항을 ArgoCD에게 알릴 필요 없이 ArgoCD가 주기적으로 Git 레포지터리의 변경사항을 확인하여 변경된 부분을 적용하게 됩니다. 이때 2가지 옵션을 추가적으로 줄 수 있습니다.

- `Prune Resources`: 변경 사항에 따라 리소스를 업데이터할 때, 기존의 리소스를 삭제하고 새로운 리소스를 생성합니다. Job 리소스처럼 매번 새로운 작업을 실행해야 하는 경우 이 옵션을 사용합니다.
- `Self Heal`: 운영 환경의 리소스가 어떠한 이유로 삭제되었을 때, ArgoCD가 git 레포지토리의 값과 운영 환경의 값을 비교하여 삭제된 리소스를 다시 생성하는 기능입니다. (자가 치유)

ArgoCD를 통해서 원천의 YAML 정의서를 운영 환경에 배포하는 방법에 대해 살펴봤습니다.

### Clean up

```bash
kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl delete ingress argocd -n argocd
kubectl delete deploy mynginx
kubectl delete svc mynginx
```