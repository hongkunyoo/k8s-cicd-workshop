# 개발 클러스터 배포

## skaffold 설치

`skaffold`는 단일 실행파일 하나만 다운받으면 설치가 완료됩니다.

```bash
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
```

### skaffold 세팅

`skaffold`를 사용하기 위해서 먼저 개발 스크립트(`app.py`), 빌드에 사용할 도커파일(`Dockerfile`), 배포에 사용할 YAML 배포 정의서(`pod.yaml`)가 각각 1개씩 필요합니다.

- 스크립트 파일

```python
# app.py
from flask import Flask
app = Flask(__name__)


@app.route('/')
def hello():
    return "Hello World!"

if __name__ == '__main__':
    app.run()
```

- 도커파일

```Dockerfile
# Dockerfile
FROM python:3.7

RUN pip install flask
ADD app.py .

ENTRYPOINT ["python", "app.py"]
```

- YAML 정의서

```yaml
# pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: skaffold-flask
spec:
  containers:
  - image: <USERNAME>/flask   # 각 사용자 docker hub 계정을 입력합니다.
    name: flask
```

-LINE_SPLITTER-

```bash
ls
# app.py    Dockerfile    pod.yaml
```

그리고 나서 `skaffold init` 명령을 실행하면 `skaffold.yaml` 이라는 파일이 생성됩니다. 해당 명령 실행 시 디렉토리 안에 앞에서 생성한 3가지 파일 외엔 다른 파일이 있으면 안됩니다.

```bash
skaffold init
# apiVersion: skaffold/v2beta5
# kind: Config
# metadata:
#   name: some-directory
# build:
#   artifacts:
#   - image: <USERNAME>/flask
# deploy:
#   kubectl:
#     manifests:
#     - pod.yaml
# 
# Do you want to write this configuration to skaffold.yaml? [y/n]: y
# Configuration skaffold.yaml was written

ls 
# app.py    Dockerfile    pod.yaml    skaffold.yaml
```

- `apiVersion`: `skaffold.yaml` 파일도 쿠버네티스의 리소스 정의서와 같이 api버전을 정의합니다.
- `kind`: `skaffold`의 `Config` 리소스인 것을 명시합니다.
- `metadata.name`: `skaffold`의 이름을 정의합니다. 디렉토리 이름이 사용됩니다.
- `build.artifacts`: 이미지 빌드 결과물을 설정합니다. `pod.yaml`에서 정의된 이미지 주소가 적혀있습니다.
- `deploy.kubectl.manifests`: 배포에 사용할 배포 정의서(YAML)가 지정되어 있습니다.

자동 배포를 수행하기 전에 먼저 도커허브 credential이 저장되어 있는지 확인합니다.

```bash
docker login
# Login with your Docker ID to push and pull images from Docker Hub. ..
# Username: <USERNAME>
# Password:
# WARNING! Your password will be stored unencrypted in ...
# Configure a credential helper to remove this warning. See
# https://docs.docker.com/engine/reference/commandline/...
# 
# Login Succeeded
```

### skaffold를 이용한 배포

`skaffold`를 이용하여 배포를 수행해 봅시다. 다음과 같이 입력하면 `skaffold`가 자동으로 이미지 빌드부터 푸시, 배포까지 자동으로 수행합니다.

```bash
skaffold run
# Generating tags...
#  - <USERNAME>/flask -> <USERNAME>/flask:latest
# Some taggers failed. Rerun with -vdebug for errors.
# ...
```

default 네임스페이스의 `Pod`를 지켜보고 있으면 자동으로 `skaffold-flask` `Pod`가 생성되는 것을 확인할 수 있습니다. 이렇게 `skaffold run` 명령 하나만으로 편리하게 쿠버네티스 개발을 수행할 수 있습니다.

```bash
kubectl get pod
# NAME             READY   STATUS              RESTARTS   AGE
# skaffold-flask   0/1     ContainerCreating   0          2m21s
```

`--tail` 옵션을 사용하면 `Pod` 로깅까지 자동으로 연결해주기 때문에 사용자가 직접 `kubectl logs`를 따로 실행하지 않아도 됩니다.

```bash
# 기존 pod 삭제
kubectl delete pod skaffold-flask
# pod "skaffold-flask" deleted

skaffold run --tail
# ...
# Press Ctrl+C to exit
# [skaffold-flask flask] starting app
# [skaffold-flask flask]  * Serving Flask app "app" (lazy loading)
# [skaffold-flask flask]  * Environment: production
# [skaffold-flask flask]    WARNING: This is a development server. Do not 
#                                  use it in a production deployment.
# [skaffold-flask flask]    Use a production WSGI server instead.
# [skaffold-flask flask]  * Debug mode: off
# [skaffold-flask flask]  * Running on http://127.0.0.1:5000/ 
#                                  (Press CTRL+C to quit)
```

마지막으로 `skaffold dev`를 실행하면 기본적으로 `skaffold run`과 동일하지만 소스코드나 도커 파일을 수정하게 되면 변경 사항을 인지하고 자동으로 다시 빌드부터 배포까지 수행합니다.

```bash
# 기존 pod 삭제
kubectl delete pod skaffold-flask
# pod "skaffold-flask" deleted

skaffold dev
```

---

**참고** 

`skaffold dev`를 실행하고 동시에 파일을 수정하기 위해서는 터미널 창을 두 개 열거나 `tmux`나 `screen`과 같은 multiplex terminal 사용하기를 추천드립니다.

---

`skaffold dev`를 실행하고 `app.py`를 일부 수정 후 저장합니다.

```python
from flask import Flask
app = Flask(__name__)


@app.route('/')
def hello():
    return "Hello World!2"

if __name__ == '__main__':
    print('start app')     # print문 추가 후 저장
    app.run()
```

`skaffold`가 변경점을 자동으로 인지하고 다시 처음부터 빌드를 하고 배포를 수행합니다.

```bash
skaffold dev
# ...
# Press Ctrl+C to exit
# [skaffold-flask flask] starting app
# [skaffold-flask flask]  * Serving Flask app "app" (lazy loading)
# [skaffold-flask flask]  * Environment: production
# [skaffold-flask flask]    WARNING: This is a development server. Do not 
#                                  use it in a production deployment.
# [skaffold-flask flask]    Use a production WSGI server instead.
# [skaffold-flask flask]  * Debug mode: off
# [skaffold-flask flask]  * Running on http://127.0.0.1:5000/ 
#                                  (Press CTRL+C to quit)
```

`skaffold dev`는 `CTRL+C`로 중단하면 `Pod` 삭제까지 자동으로 수행됩니다. `skaffold`는 쿠버네티스 개발에 있어서 없어서는 안될 편리한 툴입니다.
